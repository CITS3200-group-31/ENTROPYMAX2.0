<!DOCTYPE html>
<html>
<head>
    
    <meta http-equiv="content-type" content="text/html; charset=UTF-8" />
    <script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.3/dist/leaflet.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Leaflet.awesome-markers/2.0.2/leaflet.awesome-markers.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.3/dist/leaflet.css"/>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/css/bootstrap.min.css"/>
    <link rel="stylesheet" href="https://netdna.bootstrapcdn.com/bootstrap/3.0.0/css/bootstrap-glyphicons.css"/>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.2.0/css/all.min.css"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Leaflet.awesome-markers/2.0.2/leaflet.awesome-markers.css"/>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/python-visualization/folium/folium/templates/leaflet.awesome.rotate.min.css"/>
    
            <meta name="viewport" content="width=device-width,
                initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
            <style>
                #map_491ff8b82b7b216d8bcdf71fd2ac709d {
                    position: relative;
                    width: 100.0%;
                    height: 100.0%;
                    left: 0.0%;
                    top: 0.0%;
                }
                .leaflet-container { font-size: 1rem; }
            </style>

            <style>html, body {
                width: 100%;
                height: 100%;
                margin: 0;
                padding: 0;
            }
            </style>

            <style>#map {
                position:absolute;
                top:0;
                bottom:0;
                right:0;
                left:0;
                }
            </style>

            <script>
                L_NO_TOUCH = false;
                L_DISABLE_3D = false;
            </script>

        
</head>
<body>
    
    
        <script>
        (function() {
            var selectedMarkers = [];
            var isBoxSelecting = false;
            var boxSelectStart = null;
            var selectionBox = null;
            var ctrlPressed = false;
            var shiftPressed = false;
            
            // Global flags to check if tools are active
            window.isMeasurementModeActive = false;
            window.isArrowModeActive = false;
            window.isCircleSelectionActive = false;
            
            // Track modifier keys
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Control') ctrlPressed = true;
                if (e.key === 'Shift') shiftPressed = true;
            });
            
            document.addEventListener('keyup', function(e) {
                if (e.key === 'Control') ctrlPressed = false;
                if (e.key === 'Shift') shiftPressed = false;
            });
            
            // Wait for map to be available
            function initSelectionTool() {
                var mapKeys = Object.keys(window).filter(key => key.startsWith('map_'));
                if (mapKeys.length === 0) {
                    setTimeout(initSelectionTool, 500);
                    return;
                }
                
                var mapInstance = window[mapKeys[0]];
                
                // Handle marker clicks
                document.addEventListener('click', function(e) {
                    // Don't handle marker clicks if any tool mode is active
                    if (window.isMeasurementModeActive || window.isArrowModeActive || window.isCircleSelectionActive) {
                        console.log('Tool active, skipping marker click');
                        return;
                    }
                    
                    if (e.target.classList.contains('custom-marker')) {
                        e.stopPropagation();
                        e.preventDefault();
                        var sampleName = e.target.dataset.sampleName;
                        
                        console.log('Marker clicked:', sampleName);
                        
                        if (ctrlPressed || shiftPressed) {
                            // Multi-selection
                            var index = selectedMarkers.indexOf(sampleName);
                            if (index > -1) {
                                selectedMarkers.splice(index, 1);
                            } else {
                                selectedMarkers.push(sampleName);
                            }
                            
                            if (mapBridge) {
                                mapBridge.onMultiSelection(JSON.stringify(selectedMarkers));
                            }
                        } else {
                            // Single selection toggle
                            if (mapBridge) {
                                mapBridge.onMarkerClick(sampleName);
                            }
                        }
                    }
                });
                
                // Box selection with mouse drag
                var startLat, startLng;
                
                mapInstance.on('mousedown', function(e) {
                    if (e.originalEvent.shiftKey) {
                        isBoxSelecting = true;
                        boxSelectStart = e.latlng;
                        startLat = e.latlng.lat;
                        startLng = e.latlng.lng;
                        
                        // Create selection box
                        if (!selectionBox) {
                            selectionBox = L.rectangle([[startLat, startLng], [startLat, startLng]], {
                                color: '#2ECC71',
                                weight: 2,
                                opacity: 0.8,
                                fillOpacity: 0.2,
                                fillColor: '#2ECC71'
                            }).addTo(mapInstance);
                        }
                        
                        mapInstance.dragging.disable();
                        e.originalEvent.preventDefault();
                    }
                });
                
                mapInstance.on('mousemove', function(e) {
                    if (isBoxSelecting && selectionBox) {
                        var bounds = L.latLngBounds(boxSelectStart, e.latlng);
                        selectionBox.setBounds(bounds);
                    }
                });
                
                mapInstance.on('mouseup', function(e) {
                    if (isBoxSelecting) {
                        isBoxSelecting = false;
                        mapInstance.dragging.enable();
                        
                        if (selectionBox) {
                            var bounds = selectionBox.getBounds();
                            
                            // Find all markers within bounds
                            var markersInBounds = [];
                            document.querySelectorAll('.custom-marker').forEach(function(marker) {
                                var lat = parseFloat(marker.dataset.lat);
                                var lon = parseFloat(marker.dataset.lon);
                                var name = marker.dataset.sampleName;
                                
                                if (bounds.contains(L.latLng(lat, lon))) {
                                    markersInBounds.push(name);
                                }
                            });
                            
                            // Send to Python
                            if (mapBridge && markersInBounds.length > 0) {
                                mapBridge.onBoxSelection(JSON.stringify(markersInBounds));
                            }
                            
                            // Remove selection box
                            mapInstance.removeLayer(selectionBox);
                            selectionBox = null;
                        }
                    }
                });
                
                console.log('Selection tool initialized');
            }
            
            // Initialize after DOM is ready
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', function() {
                    setTimeout(initSelectionTool, 1000);
                });
            } else {
                setTimeout(initSelectionTool, 1000);
            }
        })();
        </script>
        
    
        <style>
        .leaflet-draw-toolbar {
            margin-top: 0;
        }
        .arrow-draw-toolbar {
            position: absolute;
            top: 90px; left: 10px;
            z-index: 1000;
            pointer-events: auto;
        }
        .arrow-draw-toolbar .leaflet-draw-section {
            position: relative;
            display: block;
        }
        .arrow-draw-toolbar a {
            background-color: #fff;
            border: 1px solid #ccc;
            width: 26px;
            height: 26px;
            line-height: 24px;
            display: block;
            text-align: center;
            text-decoration: none;
            color: black;
            cursor: pointer;
            box-shadow: 0 1px 5px rgba(0,0,0,0.2);
        }
        .arrow-draw-toolbar a:hover {
            background-color: #f4f4f4;
        }
        .arrow-draw-toolbar .arrow-draw-active {
            background-color: #a0c5e8;
            border-color: #58a1db;
        }
        .arrow-draw-toolbar .arrow-draw-active:hover {
            background-color: #8fb8dc;
        }
        .arrow-draw-toolbar .leaflet-draw-draw-arrow {
            background-image: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12,5 19,12 12,19"></polyline></svg>');
            background-position: 4px 4px;
            background-repeat: no-repeat;
            background-size: 18px 18px;
        }
        .arrow-draw-toolbar .leaflet-draw-draw-clear {
            background-image: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3,6 5,6 21,6"></polyline><path d="m19,6v14a2,2 0 0,1 -2,2H7a2,2 0 0,1 -2,-2V6m3,0V4a2,2 0 0,1 2,-2h4a2,2 0 0,1 2,2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>');
            background-position: 4px 4px;
            background-repeat: no-repeat;
            background-size: 18px 18px;
        }
        </style>
        
        <div class="arrow-draw-toolbar leaflet-bar leaflet-control">
            <div class="leaflet-draw-section">
                <a id="arrow-draw-btn" 
                   class="leaflet-draw-draw-arrow" 
                   href="#" 
                   title="Draw arrows between points">
                </a>
                <a id="arrow-clear-btn" 
                   class="leaflet-draw-draw-clear" 
                   href="#" 
                   title="Clear all arrows">
                </a>
            </div>
        </div>

        <script>
        (function() {
            // Wait for map to be available
            function initArrowTool() {
                var mapInstance = window.map_491ff8b82b7b216d8bcdf71fd2ac709d;
                
                if (!mapInstance) {
                    // Try to find map instance dynamically
                    var mapKeys = Object.keys(window).filter(key => key.startsWith('map_'));
                    if (mapKeys.length > 0) {
                        mapInstance = window[mapKeys[0]];
                    }
                }
                
                if (!mapInstance) {
                    console.warn('Map instance not found, retrying...');
                    setTimeout(initArrowTool, 500);
                    return;
                }
                
                console.log('Arrow tool initialized with map:', mapInstance);
                
                var isDrawingArrow = false;
                var arrowLayer = L.layerGroup().addTo(mapInstance);
                var startPoint = null;
                var previewLine = null;
                var drawButton = document.getElementById('arrow-draw-btn');
                var clearButton = document.getElementById('arrow-clear-btn');
                
                if (!drawButton || !clearButton) {
                    console.error('Arrow tool buttons not found');
                    return;
                }
                
                // Initialize global flag if not exists
                if (typeof window.isArrowModeActive === 'undefined') {
                    window.isArrowModeActive = false;
                }
                
                // Draw button click handler
                drawButton.addEventListener('click', function(e) {
                    e.preventDefault();
                    isDrawingArrow = !isDrawingArrow;
                    
                    // Set global flag to prevent marker selection
                    window.isArrowModeActive = isDrawingArrow;
                    
                    if (isDrawingArrow) {
                        this.className = this.className + ' arrow-draw-active';
                        mapInstance.getContainer().style.cursor = 'crosshair';
                        console.log('Arrow drawing mode activated');
                    } else {
                        this.className = this.className.replace(' arrow-draw-active', '');
                        mapInstance.getContainer().style.cursor = '';
                        startPoint = null;
                        if (previewLine) {
                            mapInstance.removeLayer(previewLine);
                            previewLine = null;
                        }
                        console.log('Arrow drawing mode deactivated');
                    }
                });
                
                // Clear button click handler
                clearButton.addEventListener('click', function(e) {
                    e.preventDefault();
                    arrowLayer.clearLayers();
                    isDrawingArrow = false;
                    window.isArrowModeActive = false;
                    drawButton.className = drawButton.className.replace(' arrow-draw-active', '');
                    mapInstance.getContainer().style.cursor = '';
                    startPoint = null;
                    if (previewLine) {
                        mapInstance.removeLayer(previewLine);
                        previewLine = null;
                    }
                    console.log('All arrows cleared');
                });
                
                // Map click handler
                mapInstance.on('click', function(e) {
                    if (!isDrawingArrow) return;
                    
                    e.originalEvent.stopPropagation();
                    
                    if (!startPoint) {
                        // First click - set start point
                        startPoint = e.latlng;
                        console.log('Arrow start point set:', startPoint);
                    } else {
                        // Second click - create arrow
                        createArrow(startPoint, e.latlng);
                        startPoint = null;
                        if (previewLine) {
                            mapInstance.removeLayer(previewLine);
                            previewLine = null;
                        }
                        console.log('Arrow created');
                    }
                });
                
                // Mouse move handler for preview
                mapInstance.on('mousemove', function(e) {
                    if (!isDrawingArrow || !startPoint) return;
                    
                    if (previewLine) {
                        mapInstance.removeLayer(previewLine);
                    }
                    
                    previewLine = L.polyline([startPoint, e.latlng], {
                        color: '#b30404',
                        weight: 2,
                        opacity: 0.6,
                        dashArray: '8, 8'
                    });
                    mapInstance.addLayer(previewLine);
                });
                
                // Create arrow function
                function createArrow(start, end) {
                    var arrowGroup = L.layerGroup();
                    
                    // Main arrow line
                    var mainLine = L.polyline([start, end], {
                        color: '#b30404',
                        weight: 4,
                        opacity: 0.8
                    });
                    
                    // Calculate arrow head
                    var startPixel = mapInstance.latLngToContainerPoint(start);
                    var endPixel = mapInstance.latLngToContainerPoint(end);
                    
                    var dx = endPixel.x - startPixel.x;
                    var dy = endPixel.y - startPixel.y;
                    var angle = Math.atan2(dy, dx);
                    
                    var headLength = 20;
                    var headAngle = Math.PI / 6; // 30 degrees
                    
                    // Calculate arrow head points
                    var head1Pixel = L.point(
                        endPixel.x - headLength * Math.cos(angle - headAngle),
                        endPixel.y - headLength * Math.sin(angle - headAngle)
                    );
                    var head2Pixel = L.point(
                        endPixel.x - headLength * Math.cos(angle + headAngle),
                        endPixel.y - headLength * Math.sin(angle + headAngle)
                    );
                    
                    var head1LatLng = mapInstance.containerPointToLatLng(head1Pixel);
                    var head2LatLng = mapInstance.containerPointToLatLng(head2Pixel);
                    
                    // Arrow head lines
                    var headLine1 = L.polyline([end, head1LatLng], {
                        color: '#b30404',
                        weight: 4,
                        opacity: 0.8
                    });
                    var headLine2 = L.polyline([end, head2LatLng], {
                        color: '#b30404',
                        weight: 4,
                        opacity: 0.8
                    });
                    
                    // Add info popup
                    var distance = (start.distanceTo(end) / 1000).toFixed(2);
                    var popupContent = `
                        <div style="font-family: Arial, sans-serif; min-width: 200px;">
                            <h4 style="margin: 0 0 8px 0; color: #b30404;">Arrow Information</h4>
                            <b>Start:</b> ${start.lat.toFixed(6)}, ${start.lng.toFixed(6)}<br>
                            <b>End:</b> ${end.lat.toFixed(6)}, ${end.lng.toFixed(6)}<br>
                            <b>Distance:</b> ${distance} km
                        </div>
                    `;
                    
                    mainLine.bindPopup(popupContent);
                    
                    // Add all parts to group
                    arrowGroup.addLayer(mainLine);
                    arrowGroup.addLayer(headLine1);
                    arrowGroup.addLayer(headLine2);
                    
                    // Add to main layer
                    arrowLayer.addLayer(arrowGroup);
                }
                
                console.log('Arrow tool fully initialized');
            }
            
            // Initialize after DOM is ready
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', function() {
                    setTimeout(initArrowTool, 1000);
                });
            } else {
                setTimeout(initArrowTool, 1000);
            }
        })();
        </script>
        
    
        <style>
        .distance-measure-toolbar {
            position: absolute;
            top: 144px; left: 10px;
            z-index: 1000;
            pointer-events: auto;
        }
        .distance-measure-toolbar .leaflet-draw-section {
            position: relative;
            display: block;
        }
        .distance-measure-toolbar a {
            background-color: #fff;
            border: 1px solid #ccc;
            width: 26px;
            height: 26px;
            line-height: 24px;
            display: block;
            text-align: center;
            text-decoration: none;
            color: black;
            cursor: pointer;
            box-shadow: 0 1px 5px rgba(0,0,0,0.2);
        }
        .distance-measure-toolbar a:hover {
            background-color: #f4f4f4;
        }
        .distance-measure-toolbar .distance-measure-active {
            background-color: #a0c5e8;
            border-color: #58a1db;
        }
        .distance-measure-toolbar .distance-measure-active:hover {
            background-color: #8fb8dc;
        }
        .distance-measure-toolbar .leaflet-draw-draw-ruler {
            background-image: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 21H3L3 3h18v18z"></path><line x1="7" y1="3" x2="7" y2="8"></line><line x1="11" y1="3" x2="11" y2="6"></line><line x1="15" y1="3" x2="15" y2="8"></line><line x1="19" y1="3" x2="19" y2="6"></line></svg>');
            background-position: 4px 4px;
            background-repeat: no-repeat;
            background-size: 18px 18px;
        }
        .distance-measure-toolbar .leaflet-draw-draw-clear-measure {
            background-image: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><line x1="15" y1="9" x2="9" y2="15"></line><line x1="9" y1="9" x2="15" y2="15"></line></svg>');
            background-position: 4px 4px;
            background-repeat: no-repeat;
            background-size: 18px 18px;
        }
        .distance-popup {
            font-family: Arial, sans-serif;
            font-size: 14px;
            font-weight: bold;
            padding: 4px 8px;
            background: rgba(255, 255, 255, 0.95);
            border: 2px solid #3388ff;
            border-radius: 4px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            color: #3388ff;
        }
        .distance-line {
            stroke: #3388ff;
            stroke-width: 3;
            stroke-dasharray: 10, 5;
            stroke-opacity: 0.8;
        }
        </style>
        
        <div class="distance-measure-toolbar leaflet-bar leaflet-control">
            <div class="leaflet-draw-section">
                <a id="distance-measure-btn" 
                   class="leaflet-draw-draw-ruler" 
                   href="#" 
                   title="Measure distance between two points">
                </a>
                <a id="distance-clear-btn" 
                   class="leaflet-draw-draw-clear-measure" 
                   href="#" 
                   title="Clear distance measurements">
                </a>
            </div>
        </div>

        <script>
        (function() {
            // Wait for map to be available
            function initDistanceTool() {
                var mapInstance = window.map_491ff8b82b7b216d8bcdf71fd2ac709d;
                
                if (!mapInstance) {
                    // Try to find map instance dynamically
                    var mapKeys = Object.keys(window).filter(key => key.startsWith('map_'));
                    if (mapKeys.length > 0) {
                        mapInstance = window[mapKeys[0]];
                    }
                }
                
                if (!mapInstance) {
                    console.warn('Map instance not found for distance tool, retrying...');
                    setTimeout(initDistanceTool, 500);
                    return;
                }
                
                console.log('Distance tool initialized with map:', mapInstance);
                
                var isMeasuring = false;
                var measurementLayer = L.layerGroup().addTo(mapInstance);
                var firstMarker = null;
                var firstMarkerData = null;
                var previewLine = null;
                var measureButton = document.getElementById('distance-measure-btn');
                var clearButton = document.getElementById('distance-clear-btn');
                var currentMeasurements = [];
                var highlightedMarkers = [];
                
                if (!measureButton || !clearButton) {
                    console.error('Distance tool buttons not found');
                    return;
                }
                
                // Function to highlight/unhighlight markers for measurement
                function highlightMarkersForMeasurement(highlight) {
                    var markers = document.querySelectorAll('.custom-marker');
                    markers.forEach(function(marker) {
                        if (highlight) {
                            marker.style.cursor = 'pointer';
                            marker.style.transition = 'all 0.2s';
                            // Add subtle pulse animation
                            if (!marker.style.animation) {
                                marker.style.animation = 'pulse 1.5s infinite';
                            }
                        } else {
                            // Only remove measurement-related styles, not selection styles
                            marker.style.cursor = '';
                            marker.style.animation = '';
                            marker.style.transition = '';
                            // Only remove bright green measurement highlight (#00ff00)
                            // Keep dark green selection highlight (#2ECC71) intact
                            if (marker.style.border && marker.style.border.includes('#00ff00')) {
                                // Restore to original or remove only measurement style
                                marker.style.border = marker.originalBorder || '';
                                marker.style.boxShadow = marker.originalBoxShadow || '';
                            }
                        }
                    });
                    
                    // Add CSS animation if not exists
                    if (highlight && !document.getElementById('pulse-animation')) {
                        var style = document.createElement('style');
                        style.id = 'pulse-animation';
                        style.innerHTML = `
                            @keyframes pulse {
                                0% { transform: scale(1); }
                                50% { transform: scale(1.1); }
                                100% { transform: scale(1); }
                            }
                        `;
                        document.head.appendChild(style);
                    }
                }
                
                // Measure button click handler
                measureButton.addEventListener('click', function(e) {
                    e.preventDefault();
                    isMeasuring = !isMeasuring;
                    
                    // Set global flag to prevent marker selection
                    window.isMeasurementModeActive = isMeasuring;
                    
                    if (isMeasuring) {
                        this.className = this.className + ' distance-measure-active';
                        mapInstance.getContainer().style.cursor = 'crosshair';
                        // Highlight all markers to show they're clickable
                        highlightMarkersForMeasurement(true);
                        console.log('Distance measurement mode activated - click on two sample points');
                    } else {
                        this.className = this.className.replace(' distance-measure-active', '');
                        mapInstance.getContainer().style.cursor = '';
                        firstMarker = null;
                        firstMarkerData = null;
                        if (previewLine) {
                            mapInstance.removeLayer(previewLine);
                            previewLine = null;
                        }
                        // Remove highlight from markers
                        highlightMarkersForMeasurement(false);
                        console.log('Distance measurement mode deactivated');
                    }
                });
                
                // Clear button click handler - only clears distance measurements
                clearButton.addEventListener('click', function(e) {
                    e.preventDefault();
                    
                    // Clear all distance measurement lines
                    measurementLayer.clearLayers();
                    currentMeasurements = [];
                    
                    // Only deactivate if tool was active
                    if (isMeasuring) {
                        isMeasuring = false;
                        window.isMeasurementModeActive = false;
                        measureButton.className = measureButton.className.replace(' distance-measure-active', '');
                        mapInstance.getContainer().style.cursor = '';
                        highlightMarkersForMeasurement(false);
                    }
                    
                    // Reset first marker if in the middle of measurement
                    if (firstMarker) {
                        // Only reset the green measurement highlight
                        if (firstMarker.style.border && firstMarker.style.border.includes('#00ff00')) {
                            firstMarker.style.boxShadow = firstMarker.originalBoxShadow || '';
                            firstMarker.style.border = firstMarker.originalBorder || '';
                        }
                        firstMarker = null;
                    }
                    firstMarkerData = null;
                    
                    if (previewLine) {
                        mapInstance.removeLayer(previewLine);
                        previewLine = null;
                    }
                    
                    console.log('Distance measurements cleared');
                });
                
                // Handle marker clicks for distance measurement
                document.addEventListener('click', function(e) {
                    if (!isMeasuring) return;
                    
                    // Check if click is on a marker
                    if (e.target.classList && e.target.classList.contains('custom-marker')) {
                        e.stopPropagation();
                        e.preventDefault();
                        
                        var markerElement = e.target;
                        var lat = parseFloat(markerElement.dataset.lat);
                        var lon = parseFloat(markerElement.dataset.lon);
                        var sampleName = markerElement.dataset.sampleName;
                        
                        if (!firstMarker) {
                            // First marker clicked
                            firstMarker = markerElement;
                            firstMarkerData = {
                                lat: lat,
                                lon: lon,
                                name: sampleName
                            };
                            // Store original styles before applying measurement highlight
                            markerElement.originalBorder = markerElement.style.border || '';
                            markerElement.originalBoxShadow = markerElement.style.boxShadow || '';
                            // Apply bright green measurement highlight
                            markerElement.style.boxShadow = '0 0 15px #00ff00';
                            markerElement.style.border = '3px solid #00ff00';
                            console.log('First point selected:', sampleName, 'at', lat, lon);
                        } else if (markerElement !== firstMarker) {
                            // Second marker clicked (must be different from first)
                            var secondMarkerData = {
                                lat: lat,
                                lon: lon,
                                name: sampleName
                            };
                            
                            // Create measurement between the two points
                            var startLatLng = L.latLng(firstMarkerData.lat, firstMarkerData.lon);
                            var endLatLng = L.latLng(secondMarkerData.lat, secondMarkerData.lon);
                            createDistanceMeasurement(startLatLng, endLatLng, firstMarkerData.name, secondMarkerData.name);
                            
                            // Reset first marker to its original styling (which may include selection)
                            firstMarker.style.boxShadow = firstMarker.originalBoxShadow || '';
                            firstMarker.style.border = firstMarker.originalBorder || '';
                            
                            // Clear selection
                            firstMarker = null;
                            firstMarkerData = null;
                            
                            if (previewLine) {
                                mapInstance.removeLayer(previewLine);
                                previewLine = null;
                            }
                            
                            console.log('Distance measured between', firstMarkerData.name, 'and', sampleName);
                        }
                    }
                });
                
                // Mouse move handler for preview line when first marker is selected
                document.addEventListener('mousemove', function(e) {
                    if (!isMeasuring || !firstMarker) return;
                    
                    // Check if hovering over a marker
                    var hoverElement = document.elementFromPoint(e.clientX, e.clientY);
                    if (hoverElement && hoverElement.classList && hoverElement.classList.contains('custom-marker') && hoverElement !== firstMarker) {
                        var lat = parseFloat(hoverElement.dataset.lat);
                        var lon = parseFloat(hoverElement.dataset.lon);
                        
                        if (previewLine) {
                            mapInstance.removeLayer(previewLine);
                        }
                        
                        var startLatLng = L.latLng(firstMarkerData.lat, firstMarkerData.lon);
                        var endLatLng = L.latLng(lat, lon);
                        
                        // Calculate distance for preview
                        var distance = startLatLng.distanceTo(endLatLng);
                        var distanceText = distance < 1000 ? 
                            Math.round(distance) + ' m' : 
                            (distance / 1000).toFixed(2) + ' km';
                        
                        previewLine = L.polyline([startLatLng, endLatLng], {
                            color: '#3388ff',
                            weight: 2,
                            opacity: 0.5,
                            dashArray: '5, 5'
                        });
                        
                        previewLine.bindTooltip(distanceText, {
                            permanent: true,
                            direction: 'center',
                            className: 'distance-popup'
                        });
                        
                        mapInstance.addLayer(previewLine);
                    } else if (previewLine) {
                        // Remove preview if not hovering over a valid marker
                        mapInstance.removeLayer(previewLine);
                        previewLine = null;
                    }
                });
                
                // Create distance measurement between two sample points
                function createDistanceMeasurement(start, end, startName, endName) {
                    var measurementGroup = L.layerGroup();
                    
                    // Calculate distance using Haversine formula
                    var distance = start.distanceTo(end);
                    var distanceText;
                    
                    if (distance < 1000) {
                        distanceText = Math.round(distance) + ' m';
                    } else {
                        distanceText = (distance / 1000).toFixed(2) + ' km';
                    }
                    
                    // Create the measurement line with thicker weight
                    var measureLine = L.polyline([start, end], {
                        color: '#ff4444',
                        weight: 4,
                        opacity: 0.9
                    });
                    
                    // Add distance label as permanent tooltip on the line
                    measureLine.bindTooltip(distanceText, {
                        permanent: true,
                        direction: 'center',
                        className: 'distance-popup'
                    });
                    
                    // Add popup with detailed information when clicking the line
                    var popupContent = `
                        <div style="font-family: Arial, sans-serif; min-width: 250px;">
                            <h4 style="margin: 0 0 8px 0; color: #ff4444;">Distance Measurement</h4>
                            <b>From:</b> ${startName}<br>
                            <b>To:</b> ${endName}<br>
                            <hr style="margin: 8px 0;">
                            <b>Point 1:</b> (${start.lat.toFixed(6)}, ${start.lng.toFixed(6)})<br>
                            <b>Point 2:</b> (${end.lat.toFixed(6)}, ${end.lng.toFixed(6)})<br>
                            <b>Distance:</b> <span style="color: #ff4444; font-size: 16px;">$${distanceText}</span><br>
                            <b>Bearing:</b> ${calculateBearing(start, end).toFixed(1)}°
                        </div>
                    `;
                    
                    measureLine.bindPopup(popupContent);
                    
                    // Add only the line to the group
                    measurementGroup.addLayer(measureLine);
                    
                    // Add to main layer
                    measurementLayer.addLayer(measurementGroup);
                    
                    // Store measurement
                    currentMeasurements.push({
                        start: start,
                        end: end,
                        startName: startName,
                        endName: endName,
                        distance: distance,
                        group: measurementGroup
                    });
                }
                
                // Calculate bearing between two points
                function calculateBearing(start, end) {
                    var startLat = start.lat * Math.PI / 180;
                    var startLng = start.lng * Math.PI / 180;
                    var endLat = end.lat * Math.PI / 180;
                    var endLng = end.lng * Math.PI / 180;
                    
                    var dLng = endLng - startLng;
                    
                    var x = Math.cos(endLat) * Math.sin(dLng);
                    var y = Math.cos(startLat) * Math.sin(endLat) - 
                            Math.sin(startLat) * Math.cos(endLat) * Math.cos(dLng);
                    
                    var bearing = Math.atan2(x, y) * 180 / Math.PI;
                    return (bearing + 360) % 360;
                }
                
                console.log('Distance tool fully initialized');
            }
            
            // Initialize after DOM is ready
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', function() {
                    setTimeout(initDistanceTool, 1000);
                });
            } else {
                setTimeout(initDistanceTool, 1000);
            }
        })();
        </script>
        
    
        <style>
        .circle-selection-toolbar {
            position: absolute;
            top: 198px; left: 10px;
            z-index: 1000;
            pointer-events: auto;
        }
        .circle-selection-toolbar .leaflet-draw-section {
            position: relative;
            display: block;
        }
        .circle-selection-toolbar a {
            background-color: #fff;
            border: 1px solid #ccc;
            width: 26px;
            height: 26px;
            line-height: 24px;
            display: block;
            text-align: center;
            text-decoration: none;
            color: black;
            cursor: pointer;
            box-shadow: 0 1px 5px rgba(0,0,0,0.2);
        }
        .circle-selection-toolbar a:hover {
            background-color: #f4f4f4;
        }
        .circle-selection-toolbar .circle-select-active {
            background-color: #a0c5e8;
            border-color: #58a1db;
        }
        .circle-selection-toolbar .circle-select-active:hover {
            background-color: #8fb8dc;
        }
        .circle-selection-toolbar .leaflet-draw-draw-circle {
            background-image: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="8"></circle><circle cx="12" cy="12" r="1" fill="currentColor"></circle></svg>');
            background-position: 4px 4px;
            background-repeat: no-repeat;
            background-size: 18px 18px;
        }
        .circle-selection-toolbar .leaflet-draw-clear-circle {
            background-image: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><line x1="8" y1="12" x2="16" y2="12"></line></svg>');
            background-position: 4px 4px;
            background-repeat: no-repeat;
            background-size: 18px 18px;
        }
        .selection-circle {
            fill: rgba(33, 150, 243, 0.2);
            stroke: #2196F3;
            stroke-width: 2;
            stroke-dasharray: 5, 5;
        }
        .selection-info {
            font-family: Arial, sans-serif;
            font-size: 12px;
            font-weight: bold;
            padding: 4px 8px;
            background: rgba(255, 255, 255, 0.95);
            border: 2px solid #2196F3;
            border-radius: 4px;
            color: #2196F3;
        }
        </style>
        
        <div class="circle-selection-toolbar leaflet-bar leaflet-control">
            <div class="leaflet-draw-section">
                <a id="circle-select-btn" 
                   class="leaflet-draw-draw-circle" 
                   href="#" 
                   title="Select points within a circular area">
                </a>
                <a id="circle-clear-btn" 
                   class="leaflet-draw-clear-circle" 
                   href="#" 
                   title="Clear circle selection">
                </a>
            </div>
        </div>

        <script>
        (function() {
            // Wait for map to be available
            function initCircleSelectionTool() {
                var mapInstance = window.map_491ff8b82b7b216d8bcdf71fd2ac709d;
                
                if (!mapInstance) {
                    // Try to find map instance dynamically
                    var mapKeys = Object.keys(window).filter(key => key.startsWith('map_'));
                    if (mapKeys.length > 0) {
                        mapInstance = window[mapKeys[0]];
                    }
                }
                
                if (!mapInstance) {
                    console.warn('Map instance not found for circle selection tool, retrying...');
                    setTimeout(initCircleSelectionTool, 500);
                    return;
                }
                
                console.log('Circle selection tool initialized');
                
                var isCircleSelecting = false;
                var selectionCircle = null;
                var centerPoint = null;
                var isDrawingCircle = false;
                var altPressed = false;
                var selectButton = document.getElementById('circle-select-btn');
                var clearButton = document.getElementById('circle-clear-btn');
                
                if (!selectButton || !clearButton) {
                    console.error('Circle selection buttons not found');
                    return;
                }
                
                // Initialize global flag if not exists
                if (typeof window.isCircleSelectionActive === 'undefined') {
                    window.isCircleSelectionActive = false;
                }
                
                // Track Alt/Option key state (Alt on Windows/Linux, Option on macOS)
                document.addEventListener('keydown', function(e) {
                    // Check for Alt key or Option key (altKey property works on all platforms)
                    if ((e.key === 'Alt' || e.altKey) && isCircleSelecting) {
                        altPressed = true;
                        mapInstance.getContainer().style.cursor = 'crosshair';
                        e.preventDefault(); // Prevent default Alt/Option behavior
                    }
                });
                
                document.addEventListener('keyup', function(e) {
                    // Check for Alt key or when altKey is released
                    if (e.key === 'Alt' || !e.altKey) {
                        altPressed = false;
                        if (isCircleSelecting && !isDrawingCircle) {
                            mapInstance.getContainer().style.cursor = 'default';
                        }
                    }
                });
                
                // Select button click handler
                selectButton.addEventListener('click', function(e) {
                    e.preventDefault();
                    isCircleSelecting = !isCircleSelecting;
                    
                    // Set global flag
                    window.isCircleSelectionActive = isCircleSelecting;
                    
                    if (isCircleSelecting) {
                        this.className = this.className + ' circle-select-active';
                        mapInstance.getContainer().style.cursor = 'default';
                        // Show hint to user (detect platform for proper key name)
                        var hint = L.control({position: 'topright'});
                        hint.onAdd = function() {
                            var div = L.DomUtil.create('div', 'circle-hint');
                            // Check if Mac for proper key name
                            var isMac = navigator.platform.toUpperCase().indexOf('MAC') >= 0;
                            var keyName = isMac ? 'Option (⌥)' : 'Alt';
                            div.innerHTML = '<div style="background: white; padding: 8px; border: 2px solid #2196F3; border-radius: 4px; font-weight: bold; color: #2196F3;">Hold ' + keyName + ' + Drag to select area</div>';
                            return div;
                        };
                        hint.addTo(mapInstance);
                        window.circleHintControl = hint;
                        var isMac = navigator.platform.toUpperCase().indexOf('MAC') >= 0;
                        var keyInstruction = isMac ? 'Option (⌥)' : 'Alt';
                        console.log('Circle selection mode activated - Hold ' + keyInstruction + ' and drag to draw selection circle');
                    } else {
                        this.className = this.className.replace(' circle-select-active', '');
                        mapInstance.getContainer().style.cursor = '';
                        centerPoint = null;
                        isDrawingCircle = false;
                        altPressed = false;
                        if (selectionCircle) {
                            mapInstance.removeLayer(selectionCircle);
                            selectionCircle = null;
                        }
                        if (window.circleHintControl) {
                            mapInstance.removeControl(window.circleHintControl);
                            window.circleHintControl = null;
                        }
                        console.log('Circle selection mode deactivated');
                    }
                });
                
                // Clear button click handler
                clearButton.addEventListener('click', function(e) {
                    e.preventDefault();
                    if (selectionCircle) {
                        mapInstance.removeLayer(selectionCircle);
                        selectionCircle = null;
                    }
                    isCircleSelecting = false;
                    isDrawingCircle = false;
                    altPressed = false;
                    window.isCircleSelectionActive = false;
                    selectButton.className = selectButton.className.replace(' circle-select-active', '');
                    mapInstance.getContainer().style.cursor = '';
                    centerPoint = null;
                    if (window.circleHintControl) {
                        mapInstance.removeControl(window.circleHintControl);
                        window.circleHintControl = null;
                    }
                    
                    // Clean up any lingering marker styles
                    document.querySelectorAll('.custom-marker').forEach(function(marker) {
                        // Remove any inline styles that might have been added
                        if (marker.style.border && marker.style.border.includes('#2196F3')) {
                            marker.style.border = '';
                        }
                        if (marker.style.boxShadow && marker.style.boxShadow.includes('#2196F3')) {
                            marker.style.boxShadow = '';
                        }
                    });
                    
                    console.log('Circle selection cleared');
                });
                
                // Mouse down handler - only works when Alt/Option is pressed
                mapInstance.on('mousedown', function(e) {
                    // Also check e.originalEvent.altKey for immediate response
                    if (!isCircleSelecting || (!altPressed && !e.originalEvent.altKey)) return;
                    
                    // Prevent normal map dragging
                    e.originalEvent.preventDefault();
                    e.originalEvent.stopPropagation();
                    
                    isDrawingCircle = true;
                    centerPoint = e.latlng;
                    mapInstance.dragging.disable();
                    
                    // Create initial circle with 0 radius
                    if (selectionCircle) {
                        mapInstance.removeLayer(selectionCircle);
                    }
                    
                    selectionCircle = L.circle(centerPoint, {
                        radius: 0,
                        color: '#2196F3',
                        weight: 2,
                        opacity: 0.8,
                        fillColor: '#2196F3',
                        fillOpacity: 0.2,
                        dashArray: '5, 5',
                        className: 'selection-circle'
                    }).addTo(mapInstance);
                    
                    console.log('Circle center set at', centerPoint.lat, centerPoint.lng);
                });
                
                // Mouse move handler for adjusting radius
                mapInstance.on('mousemove', function(e) {
                    if (!isDrawingCircle || !centerPoint || !selectionCircle) return;
                    
                    // Calculate radius based on distance from center
                    var radius = centerPoint.distanceTo(e.latlng);
                    selectionCircle.setRadius(radius);
                    
                    // Count markers within current radius
                    var count = 0;
                    document.querySelectorAll('.custom-marker').forEach(function(marker) {
                        var lat = parseFloat(marker.dataset.lat);
                        var lon = parseFloat(marker.dataset.lon);
                        var markerLatLng = L.latLng(lat, lon);
                        if (centerPoint.distanceTo(markerLatLng) <= radius) {
                            count++;
                        }
                    });
                    
                    // Update tooltip with radius and count
                    var radiusText = radius < 1000 ? 
                        Math.round(radius) + ' m' : 
                        (radius / 1000).toFixed(2) + ' km';
                    
                    selectionCircle.unbindTooltip();
                    selectionCircle.bindTooltip('Radius: ' + radiusText + ' | Points: ' + count, {
                        permanent: true,
                        direction: 'top',
                        className: 'selection-info'
                    }).openTooltip();
                });
                
                // Mouse up handler for finalizing selection
                mapInstance.on('mouseup', function(e) {
                    if (!isDrawingCircle || !centerPoint || !selectionCircle) return;
                    
                    // Re-enable map dragging
                    mapInstance.dragging.enable();
                    isDrawingCircle = false;
                    
                    // Find all markers within the circle
                    var center = selectionCircle.getLatLng();
                    var radius = selectionCircle.getRadius();
                    
                    var selectedMarkers = [];
                    document.querySelectorAll('.custom-marker').forEach(function(marker) {
                        var lat = parseFloat(marker.dataset.lat);
                        var lon = parseFloat(marker.dataset.lon);
                        var name = marker.dataset.sampleName;
                        
                        var markerLatLng = L.latLng(lat, lon);
                        var distance = center.distanceTo(markerLatLng);
                        
                        if (distance <= radius) {
                            selectedMarkers.push(name);
                            // Don't directly modify marker styles - let the selection system handle it
                        }
                    });
                    
                    // Send selection to Python via bridge
                    if (window.mapBridge && selectedMarkers.length > 0) {
                        window.mapBridge.onBoxSelection(JSON.stringify(selectedMarkers));
                        console.log('Selected', selectedMarkers.length, 'markers within circle');
                    } else if (selectedMarkers.length === 0) {
                        console.log('No markers found within circle');
                    }
                    
                    // Update visual feedback
                    var infoText = 'Selected: ' + selectedMarkers.length + ' points';
                    selectionCircle.bindTooltip(infoText, {
                        permanent: true,
                        direction: 'center',
                        className: 'selection-info'
                    }).openTooltip();
                    
                    // Reset for next selection
                    centerPoint = null;
                    mapInstance.getContainer().style.cursor = altPressed ? 'crosshair' : 'default';
                    
                    // Keep circle visible for 3 seconds then fade out
                    setTimeout(function() {
                        if (selectionCircle) {
                            selectionCircle.setStyle({
                                opacity: 0.3,
                                fillOpacity: 0.1
                            });
                        }
                    }, 3000);
                });
                
                console.log('Circle selection tool fully initialized');
            }
            
            // Initialize after DOM is ready
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', function() {
                    setTimeout(initCircleSelectionTool, 1000);
                });
            } else {
                setTimeout(initCircleSelectionTool, 1000);
            }
        })();
        </script>
        
    
            <div class="folium-map" id="map_491ff8b82b7b216d8bcdf71fd2ac709d" ></div>
        

        <script src="qrc:///qtwebchannel/qwebchannel.js"></script>
        <script>
        var mapBridge = null;
        new QWebChannel(qt.webChannelTransport, function(channel) {
            mapBridge = channel.objects.mapBridge;
            
            // Listen for selection changes from Python
            mapBridge.selectionChanged.connect(function(selectedSamples) {
                updateMapSelection(selectedSamples);
            });
        });
        
        function updateMapSelection(selectedSamples) {
            // Update visual state of markers based on selection
            document.querySelectorAll('.custom-marker').forEach(function(marker) {
                var sampleName = marker.dataset.sampleName;
                if (selectedSamples.includes(sampleName)) {
                    marker.style.border = '3px solid #2ECC71';
                    marker.style.boxShadow = '0 0 10px #2ECC71';
                } else {
                    marker.style.border = '2px solid white';
                    marker.style.boxShadow = '0 2px 6px rgba(0,0,0,0.3)';
                }
            });
        }
        </script>
        </body>
<script>
    
    
            var map_491ff8b82b7b216d8bcdf71fd2ac709d = L.map(
                "map_491ff8b82b7b216d8bcdf71fd2ac709d",
                {
                    center: [-25.0, 133.0],
                    crs: L.CRS.EPSG3857,
                    ...{
  "zoom": 5,
  "zoomControl": false,
  "preferCanvas": false,
}

                }
            );
            L.control.scale().addTo(map_491ff8b82b7b216d8bcdf71fd2ac709d);

            

        
    
            var tile_layer_56a0a79586527fcc9937d49c40e9d7a4 = L.tileLayer(
                "https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",
                {
  "minZoom": 0,
  "maxZoom": 18,
  "maxNativeZoom": 18,
  "noWrap": false,
  "attribution": "Esri",
  "subdomains": "abc",
  "detectRetina": false,
  "tms": false,
  "opacity": 1,
}

            );
        
    
            tile_layer_56a0a79586527fcc9937d49c40e9d7a4.addTo(map_491ff8b82b7b216d8bcdf71fd2ac709d);
        
</script>
</html>